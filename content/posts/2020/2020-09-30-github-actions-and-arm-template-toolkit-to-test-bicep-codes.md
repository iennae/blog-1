---
title: "GitHub Actions and ARM Template Toolkit for Bicep Codes Linting"
slug: github-actions-and-arm-template-toolkit-to-test-bicep-codes
description: "This post shows how to validate ARM templates generated by Bicep locally and integrate with GitHub Actions workflow."
date: "2020-09-30"
author: Justin-Yoo
tags:
- arm-ttk
- bicep
- github-actions
- testing
cover: https://sa0blogs.blob.core.windows.net/devkimchi/2020/09/github-actions-and-arm-template-toolkit-to-test-bicep-codes-00.png
fullscreen: true
---

Let's look at the Project Bicep and ARM Template Toolkit, and GitHub Actions for both.

* [Project Bicep Sneak Peek][post prev]
* ***GitHub Actions and ARM Template Toolkit for Bicep Codes Linting***

Once you build an ARM template, you need to verify whether the template is written in a proper way and that it works as expected. In earlier blog posts, [#1][post pester 1] and [#2][post pester 2], I described using [Pester][pester] for ARM Template validation. However, that approach required you to log in to Azure first, which is doable but less desirable. What if you could verify the template without having to log in to Azure?

In my [previous post][post prev], I introduced the [Project Bicep][gh bicep] to simplify building ARM templates. In this post, I'm going to discuss [ARM Template Toolkit (ARM-TTK)][az arm ttk] to lint and validate the templates, and applying this process  to your CI/CD pipelines using the [GitHub Actions][gh actions] workflow.

> The sample Bicep code used in this post can be downloaded from this [GitHub repository][gh sample].


## ARM Template Toolkit (ARM TTK) ##

The [ARM Template Toolkit(ARM TTK)][az arm ttk] offers a consistent and standard coding practices to build ARM templates with increased readability including:

* Validating the author's intentions by eliminating unused parameters and variables,
* Applying security practices like outputting secrets in plain text format, and
* Using environment functions to provide constants like domain suffixes, rather than hard-coded values.

As of this post, [ARM TTK is written in PowerShell][gh arm ttk] is v0.3. As PowerShell supports cross-platform, ARM TTK can also run on Windows, Mac and Linux boxes.

![][image-01]

> In order to use ARM TTK, I recommend cloning the [GitHub repository][gh arm ttk] to get the latest version rather than downloading the artifact linked from the [official document][az arm ttk] because the repository gets regularly updated at a fast pace.


## Run ARM TTK against Templates ##

First of all, run the bicep CLI to build the ARM template.

https://gist.github.com/justinyoo/0acf46566623e346553b5dabe5c1fe5b?file=01-bicep-build.ps1

Then, run the following PowerShell command. Please note that, if you want to test all ARM templates in a specific directory, there **MUST** be either an `azuredeploy.json` or `maintemplate.json` in the directory; otherwise ARM TTK will complain.

https://gist.github.com/justinyoo/0acf46566623e346553b5dabe5c1fe5b?file=02-run-arm-ttk.ps1

After I run these commands on my project, I get the following warnings showing that my template uses the old API version. For example, Azure Storage Account uses the API version of `2017-10-01`, which is older than two years. It complains that I **SHOULD** use the newest version of `2019-06-01`.

![][image-02]

After fixing all the complaints and running ARM TTK again, my project passes all the linting!

![][image-03]


## Run GitHub Actions for Bicep CLI and ARM TTK on CI/CD Pipelines ##

Now that you have the bicep CLI and ARM TTK working in your local machine, you can also add the bicep CLI and ARM TTK to your CI/CD pipelines. There are two GitHub Actions for both.

* [Bicep Build][gh actions bicep]
* [ARM TTK][gh actions arm ttk]

Here is an example of adding these actions to a CI/CD pipeline:

https://gist.github.com/justinyoo/0acf46566623e346553b5dabe5c1fe5b?file=03-github-actions.yaml&highlights=15-18,20-24,26-30

1. All the `.bicep` files are compiled to ARM templates through the Bicep Build action (line #15-18).
2. Lint those converted ARM templates through the ARM TTK action (line #20-24).
3. Display the result generated from the ARM TTK action. As the ARM TTK action returns an output as a JSON object format, you can leverage the JSON object to generate test reports (line #26-30).

Now, using this workflow, you can easily build the `.bicep` files and verify them so that only passing templates will provision resources to Azure.

But, you should make sure of one thing. Before running ARM TTK, the ARM template worked perfectly fine. However, ARM TTK complained that it was not compliant. It means that while the ARM TTK checks code quality, it doesn't validate the provisioning outcome. Therefore, to check whether the resources declared in the template will be provisioned or not, you still need additional testing logic as provided by Pester as discussed in the previous posts [#1][post pester 1] and [#2][post pester 2].

---

So far, you've set up the CI/CD pipeline with [Bicep CLI][gh actions bicep] and [ARM TTK][gh actions arm ttk] to build and verify the `.bicep` files. Can you try them out on some of your own pipelines?


[image-01]: https://sa0blogs.blob.core.windows.net/devkimchi/2020/09/github-actions-and-arm-template-toolkit-to-test-bicep-codes-01.png
[image-02]: https://sa0blogs.blob.core.windows.net/devkimchi/2020/09/github-actions-and-arm-template-toolkit-to-test-bicep-codes-02.png
[image-03]: https://sa0blogs.blob.core.windows.net/devkimchi/2020/09/github-actions-and-arm-template-toolkit-to-test-bicep-codes-03.png

[post prev]: /2020/09/09/bicep-sneak-peek/
[post pester 1]: /2018/01/22/testing-arm-templates-with-pester/
[post pester 2]: /2018/07/12/testing-arm-templates-with-pester-2/

[gh sample]: https://github.com/devkimchi/LiveStream-VM-Setup-Sample/blob/main/bicep/azuredeploy.bicep
[gh bicep]: https://github.com/Azure/bicep
[gh arm ttk]: https://github.com/Azure/arm-ttk
[gh actions]: https://github.com/features/actions
[gh actions bicep]: https://github.com/marketplace/actions/bicep-build
[gh actions arm ttk]: https://github.com/marketplace/actions/arm-template-toolkit-arm-ttk

[pester]: https://github.com/pester/Pester

[az arm ttk]: https://docs.microsoft.com/azure/azure-resource-manager/templates/test-toolkit?WT.mc_id=devkimchicom-blog-juyoo
[az arm template]: https://docs.microsoft.com/azure/azure-resource-manager/templates/overview?WT.mc_id=devkimchicom-blog-juyoo
[az arm template manual]: https://github.com/devkimchi/LiveStream-VM-Setup-Sample/blob/main/azuredeploy.json
[az arm template bicep]: https://github.com/devkimchi/LiveStream-VM-Setup-Sample/blob/main/bicep/azuredeploy.json
[az arm function providers]: https://docs.microsoft.com/azure/azure-resource-manager/templates/template-functions-resource?WT.mc_id=devkimchicom-blog-juyoo#providers
[az arm validation providers]: https://docs.microsoft.com/azure/azure-resource-manager/templates/test-cases?WT.mc_id=devkimchicom-blog-juyoo#use-hardcoded-api-version

[az bicep install]: https://github.com/Azure/bicep/blob/master/docs/installing.md
